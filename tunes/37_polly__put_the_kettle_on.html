<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>Practice</title>
    <link rel="stylesheet" href="../css/abcjs-audio.css">
    <script src="../js/abcjs-basic-min.js"></script>
    <style>
        main {
            max-width: 90%;
            margin: 0 auto;
        }

        .tune_selector,
        .audio_controls,
        .trainer_controls {
            display: flex;
            justify-content: center;
            padding: 10px;
            gap: 10px;
        }

        button,
        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
        }

        button {
            margin: 5px;
        }

        select {
            border: 1px solid;
            border-radius: 12px;
            outline: none;
            transition: border-color 0.2s;
            min-width: 120px;
        }

        .loop-active {
            background-color: red;
            color: white;
            font-weight: bold;
        }

        .warp-active {
            background-color: green;
            color: white;
            font-weight: bold;
        }

        .hide-active {
            display: none !important;
        }

        #audio_paper {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <main>
            <div class="tune_selector">
                <button class="previous">Previous Tune</button>
                <select id="tuneSelect" aria-label="Select tune"></select>
                <button class="next">Next Tune</button>
                <input type="text" name="tuneSearch" id="tuneSearch">
                <button class="goToId">Go To ID</button>
            </div>
            <div class="audio_controls">
                <button class="start">Start/Pause</button>
                <button class="restart">Restart</button>
                <button class="loop">Loop</button>
                <button class="warp25">25%</button>
                <button class="warp50">50%</button>
                <button class="warp75">75%</button>
                <button class="warp100">100%</button>
            </div>
            <div class="trainer_controls">
                <button class="speedtrainer">Speed Trainer</button>
                <button class="memorytrainer">Memory Trainer</button>
                <button class="hide">Hide Notation</button>
            </div>
        </main>
        <div id="render_paper"></div>
        <div id="audio_paper"></div>
        <div id="audio"></div>
    </div>
    <script>
        //hide mem trainer until code is updated
        document.querySelector(".memorytrainer")?.classList.toggle("hide-active");
        //Init vars
        const render_abc = [`X:37
T:Polly, Put The Kettle On
L:1/8
M:2/2
Q:1/2=88
K:D
f(g |: ab)ag f<dd(f | gf)ed c<AA(f | ab)ag f<dd(c |1 B)(dc)e def(g :|2 B)(dc)e d2 (de) ||:
f<dge f<dd(f | gf)ed c<AAg | f<dge f<dd(c |1 Bd)ce d2 (de) :|2 Bd)ce d2 d2 |]`
,`X:1
T:1 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f(g | ab)ag f<dd(f | gf)ed c<AA(f |`
,`X:1
T:2 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
ab)ag f<dd(c | B)(dc)e defg |`
,`X:1
T:1 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f(g | ab)ag f<dd(f | gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e defg |`
,`X:1
T:3 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
abag f<dd(f |  gf)ed c<AA(f |`
,`X:1
T:4 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
ab)ag f<dd(c | B)(dc)e d2 (de) ||`
,`X:1
T:2 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
abag f<dd(f |  gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e d2 (de) ||`
,`X:1
T:1 - 8 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f(g | ab)ag f<dd(f | gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e defg | abag f<dd(f |  gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e d2 (de) ||`
,`X:1
T:5 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<dd(f | gf)ed c<AAg |`
,`X:1
T:6 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f<dge f<dd(c | Bd)ce d2 (de) |`
,`X:1
T:3 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<dd(f | gf)ed c<AAg | f<dge f<dd(c | Bd)ce d2 (de) |`
,`X:1
T:7 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f<dge f<dd(f | gf)ed c<AAg |`
,`X:1
T:8 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<ddc | Bdce d2 d2 |]`
,`X:1
T:4 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f<dge f<dd(f | gf)ed c<AAg |  f<dge f<ddc | Bdce d2 d2 |]`
,`X:1
T:2 - 8 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<dd(f | gf)ed c<AAg | f<dge f<dd(c | Bd)ce d2 (de) | f<dge f<dd(f | gf)ed c<AAg |  f<dge f<ddc | Bdce d2 d2 |]`];
        const audio_abc = [`X:37
T:Polly, Put The Kettle On
L:1/8
M:2/2
Q:1/2=88
K:D
f(g |: ab)ag f<dd(f | gf)ed c<AA(f | ab)ag f<dd(c |1 B)(dc)e def(g :|2 B)(dc)e d2 (de) ||:
f<dge f<dd(f | gf)ed c<AAg | f<dge f<dd(c |1 Bd)ce d2 (de) :|2 Bd)ce d2 d2 |]`
,`X:1
T:1 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f(g | ab)ag f<dd(f | gf)ed c<AA(f |`
,`X:1
T:2 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
ab)ag f<dd(c | B)(dc)e defg |`
,`X:1
T:1 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f(g | ab)ag f<dd(f | gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e defg |`
,`X:1
T:3 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
abag f<dd(f |  gf)ed c<AA(f |`
,`X:1
T:4 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
ab)ag f<dd(c | B)(dc)e d2 (de) ||`
,`X:1
T:2 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
abag f<dd(f |  gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e d2 (de) ||`
,`X:1
T:1 - 8 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f(g | ab)ag f<dd(f | gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e defg | abag f<dd(f |  gf)ed c<AA(f | ab)ag f<dd(c | B)(dc)e d2 (de) ||`
,`X:1
T:5 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<dd(f | gf)ed c<AAg |`
,`X:1
T:6 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f<dge f<dd(c | Bd)ce d2 (de) |`
,`X:1
T:3 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<dd(f | gf)ed c<AAg | f<dge f<dd(c | Bd)ce d2 (de) |`
,`X:1
T:7 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f<dge f<dd(f | gf)ed c<AAg |`
,`X:1
T:8 - 2 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<ddc | Bdce d2 d2 |]`
,`X:1
T:4 - 4 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
f<dge f<dd(f | gf)ed c<AAg |  f<dge f<ddc | Bdce d2 d2 |]`
,`X:1
T:2 - 8 Bars - Polly, Put The Kettle On
L:1/8
Q:1/2=88
M:2/2
K:D
V:1 treble 
V:1
 f<dge f<dd(f | gf)ed c<AAg | f<dge f<dd(c | Bd)ce d2 (de) | f<dge f<dd(f | gf)ed c<AAg |  f<dge f<ddc | Bdce d2 d2 |]`];

        if (render_abc.length == 0) {
            render_abc.push(
                `X:1
T:Twinkle Twinkle
M:4/4
L:1/4
K:C
C C G G | A A G2 | F F E E | D D C2 ||
`,
                `X:2
T:Mary Had a Little Lamb
M:4/4
L:1/4
K:C
E D C D | E E E2 | D D D2 | E G G2 ||
`)
        }
        if (audio_abc.length == 0) {
            audio_abc.push(
                `X:1
T:Twinkle Twinkle
M:4/4
L:1/4
K:C
C C G G | A A G2 | F F E E | D D C2 ||
`,
                `X:2
T:Mary Had a Little Lamb
M:4/4
L:1/4
K:C
E D C D | E E E2 | D D D2 | E G G2 ||
`)
        }

        let currentTune = 0;
        let hiddenMeasures = 0;
        let totalMeasures = 0;
        let synthControl;
        let synth;
        let isLooping = false;
        let isSpeedTrainer = false;
        let isMemoryTrainer = false;
        let loopInProgress = false;
        let audioActive = false;
        const abcOptions = { add_classes: true, responsive: "resize" };

        //Init Synth
        if (ABCJS.synth.supportsAudio()) {
            synthControl = new ABCJS.synth.SynthController();
            synthControl.load("#audio", false, {
                displayLoop: true,
                displayRestart: true,
                displayPlay: true,
                displayProgress: true,
                displayWarp: true
            });
        } else {
            console.log("Audio not supported in this browser");
        }


        function toggleMemoryTrainer() {
            isMemoryTrainer = !isMemoryTrainer;
            hiddenMeasures = 0;

            // Reset all measures visible
            for (let i = 0; i < totalMeasures; i++) {
                document.querySelectorAll(`.abcjs-mm${i}`).forEach(m => m.style.display = "inline");
            }

            if (isMemoryTrainer) {
                totalMeasures = ABCJS.extractMeasures(render_abc[currentTune])[0].measures.length;
                document.querySelector(".memorytrainer")?.classList.add("loop-active");
                toggleLoop();
            } else {
                toggleLoop();
                document.querySelector(".memorytrainer")?.classList.remove("loop-active");
            }
        }

        function handlePlaybackEnded() {
            audioActive = false;
            if (isSpeedTrainer) {
                let currentWarp = parseInt(document.querySelector(".abcjs-midi-tempo")?.value, 10) || 0;
                if (currentWarp >= 100) {
                    toggleSpeedTrainer()
                    return;
                }
                synthControl.setWarp(currentWarp + 10);
            }

            if (isLooping) {
                start();
            }
            // else {
            // synthControl?.seek(0);
            // }

            // if (isMemoryTrainer && !loopInProgress) {
            //     loopInProgress = true;
            //     if (hiddenMeasures < totalMeasures) {
            //         document.querySelectorAll(`.abcjs-mm${hiddenMeasures}`).forEach(m => m.style.display = "none");
            //         hiddenMeasures++;
            //     } else {
            //         toggleLoop();
            //         isMemoryTrainer = false;
            //         for (let i = 0; i < totalMeasures; i++) {
            //             document.querySelectorAll(`.abcjs-mm${i}`).forEach(m => m.style.display = "inline");
            //         }
            //         document.querySelector(".memorytrainer")?.classList.remove("loop-active");
            //         return;
            //     }
            // }
            // setTimeout(() => loopInProgress = false, 500);
        }

        function setTune(userAction) {
            if (!synthControl) return;
            synthControl.disable(true);
            document.getElementById("tuneSelect").value = currentTune;

            const renderObj = ABCJS.renderAbc("render_paper", render_abc[currentTune], abcOptions)[0];
            const audioObj = ABCJS.renderAbc("audio_paper", audio_abc[currentTune], abcOptions)[0];

            synthControl.setTune(
                audioObj,
                userAction,
                {
                    onEnded: handlePlaybackEnded
                }
            ).then((response) => {
                console.log(response)
                // if (isLooping) {
                //     synthControl.toggleLoop();
                //     document.querySelector(".loop")?.classList.add("loop-active");        
            }
            ).catch(err => console.warn("Audio problem:", err));
        }

        function zzsetTune(userAction) {
            synthControl.disable(true);
            document.getElementById("tuneSelect").value = currentTune;

            const renderObj = ABCJS.renderAbc("render_paper", render_abc[currentTune], abcOptions)[0];
            const audioObj = ABCJS.renderAbc("audio_paper", audio_abc[currentTune], abcOptions)[0];

            // TODO-PER: This will allow the callback function to have access to timing info - this should be incorporated into the render at some point.
            synth = new ABCJS.synth.CreateSynth();
            synth.init({
                audioContext: new AudioContext(),
                visualObj: audioObj,
                // sequence: [],
                // millisecondsPerMeasure: 1000,
                // debugCallback: function(message) { console.log(message) },
                options: {
                    // soundFontUrl: "https://paulrosen.github.io/midi-js-soundfonts/FluidR3_GM/" ,
                    // sequenceCallback: function(noteMapTracks, callbackContext) { return noteMapTracks; },
                    // callbackContext: this,
                    //onEnded: handlePlaybackEnded//function(callbackContext),
                    // pan: [ -0.5, 0.5 ]
                }
            }).then(function (response) {
                console.log(response);
                // if (synthControl) {
                //     synthControl.setTune(audioObj, userAction, {
                //         onEnded: handlePlaybackEnded
                //     }).then(function (response) {
                //         console.log("Audio successfully loaded.")
                //     }).catch(function (error) {
                //         console.warn("Audio problem:", error);
                //     });
                // }
            }).catch(function (error) {
                console.warn("Audio problem:", error);
            });
        }

        //Event Listener Functions
        function previous() {
            currentTune = (currentTune - 1 + render_abc.length) % render_abc.length;
            setTune(true);
        }

        function next() {
            currentTune = (currentTune + 1) % render_abc.length;
            setTune(true);
        }

        function goto() {
            const val = parseInt(document.querySelector('#tuneSearch').value, 10);
            if (!isNaN(val) && val > 0 && val <= render_abc.length) {
                currentTune = val - 1;
                tuneSelect.value = currentTune;
                setTune(true);
            }
        }

        async function start() {
            if (!audioActive) {
                audioActive = true;
                await countdown(3);
            }
            synthControl?.play();
        }

        function restart() {
            synthControl?.restart();
        }

        function toggleLoop() {
            if (!synthControl) return;
            isLooping = !isLooping;
            document.querySelector(".loop")?.classList.toggle("loop-active");
            document.querySelectorAll(".audio_controls button:not(.loop), .speedtrainer").forEach(function (el) {
                el?.classList.toggle("hide-active");
            });
            // document.querySelectorAll(".trainer_controls button:not(.memorytrainer,.hide)").forEach(function (el) {
            //     el?.classList.toggle("hide-active");
            // });
            // if (isLooping || !isSpeedTrainer) {
            //     document.querySelector(".speedtrainer")?.classList.toggle("hide-active");
            // }
            synthControl?.seek(0);
            start();
        }

        function warp(amount) {
            if (!synthControl) return;
            synthControl.setWarp(amount);
            document.querySelectorAll(".warp25, .warp50, .warp75, .warp100")
                .forEach(btn => btn.classList.remove("warp-active"));
            document.querySelector(`.warp${amount}`)?.classList.add("warp-active");
        }

        function toggleSpeedTrainer() {
            isSpeedTrainer = !isSpeedTrainer;
            isLooping = !isLooping

            if (isSpeedTrainer) {
                synthControl?.setWarp(30);
            }

            document.querySelector(".speedtrainer")?.classList.toggle("loop-active");
            document.querySelectorAll(".audio_controls").forEach(function (el) {
                el?.classList.toggle("hide-active");
            });
            document.querySelectorAll(".audio_controls [class^='warp']").forEach(function (el) {
                el?.classList.remove("warp-active");
            });
            synthControl?.seek(0);
            start();
        }

        function hide() {
            document.querySelector("#render_paper")?.classList.toggle("hide-active")
        }

        function countdown(seconds) {
            return new Promise(resolve => {
                let overlay = document.createElement("div");
                overlay.style.position = "fixed";
                overlay.style.top = "0";
                overlay.style.left = "0";
                overlay.style.width = "100%";
                overlay.style.height = "100%";
                overlay.style.background = "rgba(0,0,0,0.7)";
                overlay.style.display = "flex";
                overlay.style.alignItems = "center";
                overlay.style.justifyContent = "center";
                overlay.style.fontSize = "5em";
                overlay.style.color = "white";
                overlay.style.zIndex = "9999";
                document.body.appendChild(overlay);

                let count = seconds;
                overlay.textContent = count;
                const interval = setInterval(() => {
                    count--;
                    if (count <= 0) {
                        clearInterval(interval);
                        document.body.removeChild(overlay);
                        resolve();
                    } else {
                        overlay.textContent = count;
                    }
                }, 1000);
            });
        }

        //Map elements to functions
        const actions = {
            ".previous": previous,
            ".next": next,
            ".goToId": goto,
            ".start": start,
            ".restart": restart,
            ".loop": toggleLoop,
            //to pass function params, use anon function
            ".warp25": () => warp(25),
            ".warp50": () => warp(50),
            ".warp75": () => warp(75),
            ".warp100": () => warp(100),
            ".speedtrainer": toggleSpeedTrainer,
            ".memorytrainer": toggleMemoryTrainer,
            ".hide": hide
        };

        // Attach button listeners
        Object.entries(actions).forEach(([selector, handler]) =>
            document.querySelector(selector)?.addEventListener("click", handler)
        );

        // Populate tune dropdown
        const tuneSelect = document.getElementById("tuneSelect");
        render_abc.forEach((tune, i) => {
            const option = document.createElement("option");
            option.value = i;
            option.textContent = `${i + 1} - ${(tune.match(/\nT:\s*(.+)/) || [, "Untitled"])[1].trim()}`;
            tuneSelect.appendChild(option);
        });

        tuneSelect.addEventListener("change", () => {
            currentTune = parseInt(tuneSelect.value, 10);
            setTune(true);
        });

        //Load Tune
        setTune(false);
    </script>
</body>

</html>