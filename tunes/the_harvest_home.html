
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <title>Practice</title>
    <link rel="stylesheet" href="../css/abcjs-audio.css">
    <script src="../js/abcjs-basic-min.js" defer></script>
    <style>
        main {
            max-width: 90%;
            margin: 0 auto;
        }

        .tune_selector,
        .audio_controls {
            display: flex;
            justify-content: center;
            padding: 10px;
        }

        button {
            padding: 10px;
            margin: 10px;
            font-size: 16px;
            border-radius: 8px;
        }

        select {
            border: 1px solid;
            border-radius: 12px;
            padding: 10px 12px;
            outline: none;
            transition: border-color 0.2s;
            font-size: 16px;
            min-width: 120px;
        }

        .loop-active {
            background-color: red;
            color: white;
            font-weight: bold;
        }

        .warp-active {
            background-color: green;
            color: white;
            font-weight: bold;
        }

        .hide-active{
            display: none !important;;
        }

        #audio_paper {
            display: none;
        }
    </style>
    <script type="text/javascript">
        const render_abc = [`X:6
T:The Harvest Home
R:hornpipe
L:1/4
M:2/2
Q:1/2=92
K:D
(A/F/) |: D/A/F/A/ D/A/F/A/ | d/(e/{/a}f/e/) d/(c/B/A/) | e/A/f/A/ g/A/f/A/ | (3(e/f/e/) (3(d/c/B/) (3(A/B/A/) (3(G/F/E/) | 
D/A/F/A/ D/A/F/A/ | d/(e/{/a}f/e/) d/(c/B/A/) | e/A/f/A/ g/e/c/e/ |1  d f d (A/F/):|2 d f d (c/d/) ||
|: (e/A/) (3A/A/A/ (f/A/) (3A/A/A/ | g/A/f/A/ (e/A/) (3A/A/A/ |e/A/f/A/ g/A/f/A/ | (3(e/f/e/) (3(d/c/B/) (3(A/B/A/) (3(G/F/E/) | 
D/A/F/A/ D/A/F/A/ |d/(e/{/a}f/e/) d/(c/B/A/) |  e/A/f/A/ g/e/c/e/ |1 d f d (c/d/):|2 d f d2 |]`,
`X:1
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(AF) | DAFA DAFA | d(e{/a}fe) d(cBA) |`,
`X:2
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:3
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) |`,
`X:4
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d2 (AF) |`,
`X:5
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) |`,
`X:6
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:7
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) |`,
`X:8
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d2 (cd) ||`,
`X:9
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA |`,
`X:10
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:11
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA |  d(e{/a}fe) d(cBA) |`,
`X:12
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d2 (cd) |`,
`X:13
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA |`,
`X:14
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA |  (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:15
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) |`,
`X:16
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d4 |]`,
`X:1
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(AF) | DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:2
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d2 (AF) |`,
`X:3
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:4
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d2 (cd) ||`,
`X:5
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:6
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA |  d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d2 (cd) |`,
`X:7
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA |  (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:8
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d4 |]`,
`X:1
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(AF) | DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d2 (AF) |`,
`X:2
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d2 (cd) ||`,
`X:3
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA |  d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d2 (cd) |`,
`X:4
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA |  (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA | d(e{/a}fe) d(cBA) | eAfA gece | d2 f2 d4 |]`];
        const audio_abc = [`X:6
T:The Harvest Home
R:hornpipe
L:1/4
M:2/2
Q:1/2=92
K:D
(A/F/) |: D/A/F/A/ D/A/F/A/ | d/(e/f/e/) d/(c/B/A/) | e/A/f/A/ g/A/f/A/ | (3(e/f/e/) (3(d/c/B/) (3(A/B/A/) (3(G/F/E/) | 
D/A/F/A/ D/A/F/A/ | d/(e/f/e/) d/(c/B/A/) | e/A/f/A/ g/e/c/e/ |1  d f d (A/F/):|2 d f d (c/d/) ||
|: (e/A/) (3A/A/A/ (f/A/) (3A/A/A/ | g/A/f/A/ (e/A/) (3A/A/A/ |e/A/f/A/ g/A/f/A/ | (3(e/f/e/) (3(d/c/B/) (3(A/B/A/) (3(G/F/E/) | 
D/A/F/A/ D/A/F/A/ |d/(e/f/e/) d/(c/B/A/) |  e/A/f/A/ g/e/c/e/ |1 d f d (c/d/):|2 d f d2 |]`,
`X:1
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(AF) | DAFA DAFA | d(efe) d(cBA) |`,
`X:2
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:3
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) |`,
`X:4
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d2 (AF) |`,
`X:5
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) |`,
`X:6
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:7
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) |`,
`X:8
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d2 (cd) ||`,
`X:9
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA |`,
`X:10
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:11
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA |  d(efe) d(cBA) |`,
`X:12
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d2 (cd) |`,
`X:13
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA |`,
`X:14
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gAfA |  (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:15
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) |`,
`X:16
T:2 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
eAfA gece | d2 f2 d4 |]`,
`X:1
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(AF) | DAFA DAFA | d(efe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:2
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) | eAfA gece | d2 f2 d2 (AF) |`,
`X:3
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:4
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) | eAfA gece | d2 f2 d2 (cd) ||`,
`X:5
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:6
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA |  d(efe) d(cBA) | eAfA gece | d2 f2 d2 (cd) |`,
`X:7
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA |  (3(efe) (3(dcB) (3(ABA) (3(GFE) |`,
`X:8
T:4 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) | eAfA gece | d2 f2 d4 |]`,
`X:1
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(AF) | DAFA DAFA | d(efe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA | d(efe) d(cBA) | eAfA gece | d2 f2 d2 (AF) |`,
`X:2
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
DAFA DAFA | d(efe) d(cBA) | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA | d(efe) d(cBA) | eAfA gece | d2 f2 d2 (cd) ||`,
`X:3
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA | (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA |  d(efe) d(cBA) | eAfA gece | d2 f2 d2 (cd) |`,
`X:4
T:8 Bars - The Harvest Home
L:1/8
Q:1/2=92
M:2/2
K:D
V:1 treble 
V:1
(eA) (3AAA (fA) (3AAA | gAfA (eA) (3AAA | eAfA gAfA |  (3(efe) (3(dcB) (3(ABA) (3(GFE) | DAFA DAFA | d(efe) d(cBA) | eAfA gece | d2 f2 d4 |]`];
        
        let currentTune = 0;
        let synthControl;
        let isLooping = false;
        let isTrainer = false;
        let currentWarp;

        const abcOptions = {
            add_classes: true,
            responsive: "resize"
        };

        function load() {
            const actions = {
                ".previous": previous,
                ".next": next,
                ".loop": toggleLoop,
                ".start": start,
                ".restart": restart,
                ".warp50": () => warp(50),
                ".warp75": () => warp(75),
                ".warp100": () => warp(100),
                ".trainer": toggleTrainer,
                ".hide": toggleHide
            };

            // Attach button listeners
            Object.entries(actions).forEach(([selector, handler]) => {
                const el = document.querySelector(selector);
                if (el) el.addEventListener("click", handler);
            });

            // Populate tune dropdown
            const tuneSelect = document.getElementById("tuneSelect");
            render_abc.forEach((tune, index) => {
                const option = document.createElement("option");
                option.value = index;
                const title = (tune.match(/\nT:\s*(.+)/) || [null, "Untitled"])[1].trim();
                option.textContent = `${index + 1} - ${title}`;
                tuneSelect.appendChild(option);
            });

            // Handle selection change
            tuneSelect.addEventListener("change", () => {
                currentTune = parseInt(tuneSelect.value, 10);
                setTune(true);
            });

            // Setup synth controller
            if (ABCJS.synth.supportsAudio()) {
                synthControl = new ABCJS.synth.SynthController();
                synthControl.load("#audio", false, {
                    displayLoop: true,
                    displayRestart: true,
                    displayPlay: true,
                    displayProgress: true,
                    displayWarp: true
                });
            } else {
                console.log("Audio is not supported in this browser");
            }

            setTune(false);
        }

        function toggleLoop() {
            if (!synthControl) return;
            isLooping = !isLooping;
            synthControl.toggleLoop();
            document.querySelector(".loop")?.classList.toggle("loop-active");
        }

        function start() {
            synthControl?.play();
        }

        function restart() {
            synthControl?.restart();
        }

        function warp(amount) {
            if (!synthControl) return;
            synthControl.setWarp(amount);

            document.querySelectorAll(".warp50, .warp75, .warp100")
                .forEach(btn => btn.classList.remove("warp-active"));

            document.querySelector(`.warp${amount}`)?.classList.add("warp-active");
        }

        function toggleHide() {
            document.querySelector("#render_paper")?.classList.toggle("hide-active");
        }

        function toggleTrainer() {
            isTrainer = !isTrainer;
            synthControl?.setWarp(50);
            document.querySelector(".trainer")?.classList.toggle("loop-active");
            synthControl?.play();
        }

        function handlePlaybackEnded() {
            if (!isTrainer) return;

            currentWarp = parseInt(document.querySelector(".abcjs-midi-tempo")?.value, 10) || 0;

            if (currentWarp >= 100) {
                isTrainer = false;
                document.querySelector(".trainer")?.classList.remove("loop-active");
                return;
            }

            synthControl.restart();
            synthControl.setWarp(currentWarp + 10);
            synthControl.play();
        }

        function setTune(userAction) {
            if (!synthControl) return;

            synthControl.disable(true);
            document.getElementById("tuneSelect").value = currentTune;

            // Render ABC
            ABCJS.renderAbc("render_paper", render_abc[currentTune], abcOptions);
            const audioObj = ABCJS.renderAbc("audio_paper", audio_abc[currentTune], {})[0];

            synthControl.setTune(audioObj, userAction, { onEnded: handlePlaybackEnded })
                .then(() => {
                    console.log("Audio successfully loaded.");
                    if (isLooping) {
                        synthControl.toggleLoop();
                        document.querySelector(".loop")?.classList.add("loop-active");
                    }
                })
                .catch(error => console.warn("Audio problem:", error));
        }

        function previous() {
            currentTune = (currentTune - 1 + render_abc.length) % render_abc.length;
            setTune(true);
        }

        function next() {
            currentTune = (currentTune + 1) % render_abc.length;
            setTune(true);
        }

    </script>
</head>

<body onload="load()">
    <header>
    </header>
    <div class="container">
        <main>
            <div class="button_container">
                <div class="tune_selector">
                    <button class="previous">Previous Tune</button>
                    <select id="tuneSelect" aria-label="Select tune"></select>
                    <button class="next">Next Tune</button>
                </div>
                <div class="audio_controls">
                    <button class="start">Start/Pause</button>
                    <button class="restart">Restart</button>
                    <button class="loop">Loop</button>
                    <button class="warp50">50%</button>
                    <button class="warp75">75%</button>
                    <button class="warp100">100%</button>
                    <button class="trainer">Speed Trainer</button>
                    <button class="hide">Hide Notation</button>
                </div>
            </div>
        </main>
        <div id="render_paper"></div>
        <div id="audio_paper"></div>
        <div id="audio"></div>
        </main>
    </div>
</body>

</html>
