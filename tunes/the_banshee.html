<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>Practice</title>
    <link rel="stylesheet" href="../css/abcjs-audio.css">
    <script src="../js/abcjs-basic-min.js" defer></script>
    <style>
        main {
            max-width: 90%;
            margin: 0 auto;
        }

        .tune_selector,
        .audio_controls,
        .trainer_controls {
            display: flex;
            justify-content: center;
            padding: 10px;
            gap: 10px;
        }

        button,
        select {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
        }

        button {
            margin: 5px;
        }

        select {
            border: 1px solid;
            border-radius: 12px;
            outline: none;
            transition: border-color 0.2s;
            min-width: 120px;
        }

        .loop-active {
            background-color: red;
            color: white;
            font-weight: bold;
        }

        .warp-active {
            background-color: green;
            color: white;
            font-weight: bold;
        }

        .hide-active {
            display: none !important;
        }

        #audio_paper {
            display: none;
        }
    </style>
    <script>
        const render_abc = [`X:9
T:The Banshee
R:reel
L:1/8
M:2/2
Q:1/2=120
K:G
(DE) |: G3 (D ED)EG | AGA(B d2) Bd | ege(d BA)GA | B(AG)(E{/G} ED)DE |
GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA |1 BAG(E{/G} ED) (DE):|2 BAG(E{/G} ED) DD ||:
e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | e(B{/d} B2) egfg | e(B{/d}BA) !turn!B3 d |
e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | ege(d BA)GA |1 BAG(E{/G} ED) DD :|2 BAG(E{/G} ED) DE| G6|]`,
`X:1
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
(DE) | G3 (D ED)EG | AGA(B d2) Bd | ege(d BA)GA | B(AG)(E{/G} ED)DE |`,
`X:2
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
 GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E{/G} ED) (DE) |`,
`X:3
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G3 (D ED)EG | AGA(B d2) Bd |  ege(d BA)GA | B(AG)(E{/G} ED)DE |`,
`X:4
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
 GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E{/G} ED) DD ||`,
`X:5
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | e(B{/d} B2) egfg | e(B{/d}BA) !turn!B3 d |`,
`X:6
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | ege(d BA)GA | BAG(E{/G} ED) DD |`,
`X:7
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | e(B{/d} B2) egfg | e(B{/d}BA) !turn!B3 d |`,
`X:8
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
 e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | ege(d BA)GA | BAG(E{/G} ED) DE |`,
`X:9
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G6 |]`,
`X:1
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
(DE) | G3 (D ED)EG | AGA(B d2) Bd | ege(d BA)GA | B(AG)(E{/G} ED)DE |  GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E{/G} ED) (DE) |`,
`X:2
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G3 (D ED)EG | AGA(B d2) Bd |  ege(d BA)GA | B(AG)(E{/G} ED)DE |  GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E{/G} ED) DD ||`,
`X:3
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | e(B{/d} B2) egfg | e(B{/d}BA) !turn!B3 d | e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | ege(d BA)GA | BAG(E{/G} ED) DD |`,
`X:4
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | e(B{/d} B2) egfg | e(B{/d}BA) !turn!B3 d |  e(a{/b}ag) efge | d(B{/d}BA) !turn!B3 d | ege(d BA)GA | BAG(E{/G} ED) DE |`,
`X:5
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G6 |]`];
        const audio_abc = [`X:9
T:The Banshee
R:reel
L:1/8
M:2/2
Q:1/2=120
K:G
(DE) |: G3 (D ED)EG | AGA(B d2) Bd | ege(d BA)GA | B(AG)(E ED)DE |
GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA |1 BAG(E ED) (DE):|2 BAG(E ED) DD ||:
e(aag) efge | d(BBA) B3 d | e(B B2) egfg | e(BBA) B3 d |
e(aag) efge | d(BBA) B3 d | ege(d BA)GA |1 BAG(E ED) DD :|2 BAG(E ED) DE| G6|]`,
`X:1
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
(DE) | G3 (D ED)EG | AGA(B d2) Bd | ege(d BA)GA | B(AG)(E ED)DE |`,
`X:2
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
 GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E ED) (DE) |`,
`X:3
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G3 (D ED)EG | AGA(B d2) Bd |  ege(d BA)GA | B(AG)(E ED)DE |`,
`X:4
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
 GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E ED) DD ||`,
`X:5
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(aag) efge | d(BBA) B3 d | e(B B2) egfg | e(BBA) B3 d |`,
`X:6
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(aag) efge | d(BBA) B3 d | ege(d BA)GA | BAG(E ED) DD |`,
`X:7
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(aag) efge | d(BBA) B3 d | e(B B2) egfg | e(BBA) B3 d |`,
`X:8
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
 e(aag) efge | d(BBA) B3 d | ege(d BA)GA | BAG(E ED) DE |`,
`X:9
T:4 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G6 |]`,
`X:1
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
(DE) | G3 (D ED)EG | AGA(B d2) Bd | ege(d BA)GA | B(AG)(E ED)DE |  GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E ED) (DE) |`,
`X:2
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G3 (D ED)EG | AGA(B d2) Bd |  ege(d BA)GA | B(AG)(E ED)DE |  GFG(D ED)EG | AGA(B d2) Bd | ege(d BA)GA | BAG(E ED) DD ||`,
`X:3
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(aag) efge | d(BBA) B3 d | e(B B2) egfg | e(BBA) B3 d | e(aag) efge | d(BBA) B3 d | ege(d BA)GA | BAG(E ED) DD |`,
`X:4
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
e(aag) efge | d(BBA) B3 d | e(B B2) egfg | e(BBA) B3 d |  e(aag) efge | d(BBA) B3 d | ege(d BA)GA | BAG(E ED) DE |`,
`X:5
T:8 Bars - The Banshee
L:1/8
Q:1/2=120
M:2/2
K:G
V:1 treble 
V:1
G6 |]`];
        let currentTune = 0;
        let hiddenMeasures = 0;
        let totalMeasures = 0;
        let synthControl;
        let isLooping = false;
        let isSpeedTrainer = false;
        let isMemoryTrainer = false;
        let loopInProgress = false;

        const abcOptions = { add_classes: true, responsive: "resize" };

        function load() {
            const actions = {
                ".previous": previous,
                ".next": next,
                ".loop": toggleLoop,
                ".start": () => synthControl?.play(),
                ".restart": () => synthControl?.restart(),
                ".warp25": () => warp(25),
                ".warp50": () => warp(50),
                ".warp75": () => warp(75),
                ".warp100": () => warp(100),
                ".speedtrainer": toggleSpeedTrainer,
                ".memorytrainer": toggleMemoryTrainer,
                ".hide": () => document.querySelector("#render_paper")?.classList.toggle("hide-active")
            };

            // Attach button listeners
            Object.entries(actions).forEach(([selector, handler]) =>
                document.querySelector(selector)?.addEventListener("click", handler)
            );

            // Populate tune dropdown
            const tuneSelect = document.getElementById("tuneSelect");
            render_abc.forEach((tune, i) => {
                const option = document.createElement("option");
                option.value = i;
                option.textContent = `${i + 1} - ${(tune.match(/\nT:\s*(.+)/) || [, "Untitled"])[1].trim()}`;
                tuneSelect.appendChild(option);
            });

            tuneSelect.addEventListener("change", () => {
                currentTune = parseInt(tuneSelect.value, 10);
                setTune(true);
            });

            if (ABCJS.synth.supportsAudio()) {
                synthControl = new ABCJS.synth.SynthController();
                synthControl.load("#audio", false, {
                    displayLoop: true,
                    displayRestart: true,
                    displayPlay: true,
                    displayProgress: true,
                    displayWarp: true
                });
            } else {
                console.log("Audio not supported in this browser");
            }

            setTune(false);
        }

        function toggleLoop() {
            if (!synthControl) return;
            isLooping = !isLooping;
            synthControl.toggleLoop(true);
            document.querySelector(".loop")?.classList.toggle("loop-active");
            synthControl.play();
            if (!isLooping) restart();
        }

        function warp(amount) {
            if (!synthControl) return;
            synthControl.setWarp(amount);
            document.querySelectorAll(".warp25, .warp50, .warp75, .warp100")
                .forEach(btn => btn.classList.remove("warp-active"));
            document.querySelector(`.warp${amount}`)?.classList.add("warp-active");
        }

        function toggleSpeedTrainer() {
            isSpeedTrainer = !isSpeedTrainer;

            if (isSpeedTrainer) {
                synthControl?.setWarp(50);
                synthControl?.play();
            }

            document.querySelector(".speedtrainer")?.classList.toggle("loop-active");

        }

        function toggleMemoryTrainer() {
            isMemoryTrainer = !isMemoryTrainer;
            hiddenMeasures = 0;

            // Reset all measures visible
            for (let i = 0; i < totalMeasures; i++) {
                document.querySelectorAll(`.abcjs-mm${i}`).forEach(m => m.style.display = "inline");
            }

            if (isMemoryTrainer) {
                totalMeasures = ABCJS.extractMeasures(render_abc[currentTune])[0].measures.length;
                document.querySelector(".memorytrainer")?.classList.add("loop-active");
                toggleLoop();
            } else {
                toggleLoop();
                document.querySelector(".memorytrainer")?.classList.remove("loop-active");
            }
        }

        function handlePlaybackEnded() {
            if (isSpeedTrainer) {
                let currentWarp = parseInt(document.querySelector(".abcjs-midi-tempo")?.value, 10) || 0;
                if (currentWarp >= 100) {
                    isSpeedTrainer = false;
                    document.querySelector(".speedtrainer")?.classList.remove("loop-active");
                    return;
                }
                synthControl.setWarp(currentWarp + 10);
                return synthControl.play();
            }

            if (isMemoryTrainer && !loopInProgress) {
                loopInProgress = true;
                if (hiddenMeasures < totalMeasures) {
                    document.querySelectorAll(`.abcjs-mm${hiddenMeasures}`).forEach(m => m.style.display = "none");
                    hiddenMeasures++;
                } else {
                    toggleLoop();
                    isMemoryTrainer = false;
                    for (let i = 0; i < totalMeasures; i++) {
                        document.querySelectorAll(`.abcjs-mm${i}`).forEach(m => m.style.display = "inline");
                    }
                    document.querySelector(".memorytrainer")?.classList.remove("loop-active");
                    return;
                }
            }
            setTimeout(() => loopInProgress = false, 500);
        }

        function setTune(userAction) {
            if (!synthControl) return;
            synthControl.disable(true);
            document.getElementById("tuneSelect").value = currentTune;

            ABCJS.renderAbc("render_paper", render_abc[currentTune], abcOptions);
            const audioObj = ABCJS.renderAbc("audio_paper", audio_abc[currentTune], {})[0];

            synthControl.setTune(audioObj, userAction, { onEnded: handlePlaybackEnded })
                .then(() => {
                    if (isLooping) {
                        synthControl.toggleLoop();
                        document.querySelector(".loop")?.classList.add("loop-active");
                    }
                })
                .catch(err => console.warn("Audio problem:", err));
        }

        const previous = () => { currentTune = (currentTune - 1 + render_abc.length) % render_abc.length; setTune(true); };
        const next = () => { currentTune = (currentTune + 1) % render_abc.length; setTune(true); };
        const restart = () => synthControl?.restart();

    </script>
</head>

<body onload="load()">
    <div class="container">
        <main>
            <div class="tune_selector">
                <button class="previous">Previous Tune</button>
                <select id="tuneSelect" aria-label="Select tune"></select>
                <button class="next">Next Tune</button>
            </div>
            <div class="audio_controls">
                <button class="start">Start/Pause</button>
                <button class="restart">Restart</button>
                <button class="loop">Loop</button>
                <button class="warp25">25%</button>
                <button class="warp50">50%</button>
                <button class="warp75">75%</button>
                <button class="warp100">100%</button>
            </div>
            <div class="trainer_controls">
                <button class="speedtrainer">Speed Trainer</button>
                <button class="memorytrainer">Memory Trainer</button>
                <button class="hide">Hide Notation</button>
            </div>
        </main>
        <div id="render_paper"></div>
        <div id="audio_paper"></div>
        <div id="audio"></div>
    </div>
</body>

</html>